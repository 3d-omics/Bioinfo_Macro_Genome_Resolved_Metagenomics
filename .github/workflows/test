#!/usr/bin/env bash
set -euo pipefail

rm -rf results reports

./run \
    --jobs 8 \
    preprocess__bowtie2 \
    preprocess__fastp \
    preprocess__kraken2 \
    preprocess__samtools \

./run \
    --jobs 8 \
    assemble__megahit

# generate mock assembly
cp \
    resources/mock_assembly.fa.gz \
    results/assemble/megahit/all.fa.gz

./run \
    --jobs 8 \
    prokaryotes__cluster__magscot \
    --rerun-triggers mtime

# Run drep
mkdir --parents results/prokaryotes/cluster/drep/separated_bins
touch results/prokaryotes/cluster/drep/separated_bins/.snakemake_timestamp
cp \
    resources/mock_assembly.fa.gz \
    results/prokaryotes/cluster/drep/separated_bins/bin1.fa.gz
cp \
    resources/mock_assembly.fa.gz \
    results/prokaryotes/cluster/drep/separated_bins/bin2.fa.gz


# Skip drep-related results
cp \
    resources/mock_assembly.fa.gz \
    results/prokaryotes/cluster/drep/dereplicated_genomes.fa.gz
touch results/prokaryotes/cluster/drep/dereplicated_genomes.fa.gz
mkdir --parents results/prokaryotes/cluster/drep/dereplicated_genomes
touch results/prokaryotes/cluster/drep/dereplicated_genomes/.snakemake_timestamp
cp \
    resources/mock_assembly.fa.gz \
    results/prokaryotes/cluster/drep/dereplicated_genomes/bin1.fa.gz
cp \
    resources/mock_assembly.fa.gz \
    results/prokaryotes/cluster/drep/dereplicated_genomes/bin2.fa.gz
touch \
    results/prokaryotes/cluster/drep/data.tar.gz \
    results/prokaryotes/cluster/drep/data_tables.tar.gz



./run \
    --jobs 8 \
    prokaryotes__quantify \
    --rerun-triggers mtime

./run \
    --jobs 8 \
    prokaryotes__annotate__quast \
    --rerun-triggers mtime

./run \
    --jobs 4 \
    viruses \
    --rerun-triggers mtime

./run \
    --jobs 8 \
    report \
    --rerun-triggers mtime
